<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.6.4/math.min.js"></script>

    <!-- <script src="SupportLibraries/astroFunctions.js"></script> -->
    <script src="./js/Cap1v1main.js"></script>
    <script src="./js/Cap1v1Trajectories.js"></script>
    <script src="./js/Cap1v1HandleEvents.js"></script>
    <title>RPO 1v1</title>

    <link rel="stylesheet" type="text/css" href="css/Capstone1v1.css">
</head>

<body>
    <ul class="navbar">
        <li style="padding-left: 2%; font-size: 2.5vw;">
            <p id="navTitle">1v1 Simulator</p>
        </li>
        <li class="pointer" id="turn-button" style="margin-left: 30%; font-size: 2vw;">
            <p>Turn <span>1</span></p>
        </li>
        <li class="pointer" id="setup" style="float: right; padding-right: 2%; font-size: 2vw;">
            <p>Instructions &#9776;</p>
        </li>
    </ul>
    <div class="instruction-screen">
        <h2>How to Play Test</h2>
        <h4><u>Goal</u></h4>
        <p>Move blue satellite into an advantageous position with respect to the Sun vector and the red satellite.
            Success will be defined by the specific mission.
        </p>
        <br>
        <h4><u>Planning Manuevers</u></h4>
        <p>User is able to plan a maneuver on their RSO every 3 hours for 15 hours</p>
        <ol>
            <li>Double-click on the desired waypoint to undergo a maneuver</li>
            <li>The mouse position relative to the waypoint will decide the magnitue and direction of the maneuver</li>
            <li>Real-time maneuver data will be displayed on the left of the screen for each time</li>
            <li>Click again to lock in chosen maneuver</li>
            <li>Maneuver magnitude will not go above referee defined maximum</li>
            <li>Alternatively, user can press [E] and manually enter maneuvers</li>
        </ol>
        <p>The slider will allow user to view satellite/Sun positions at any scenario time</p>
    </div>
    <div class="setup-screen">
        <div class="setup-container">
            <p class="container-title" style="color: rgb(100,150,255)">Blue Satellite</p>
            <p class="container-title2"><u>Initial State</u></p>
            <p class="container-title2"><em>Ae</em>: <input class="rmoe-input" value="0.0"> km</p>
            <p class="container-title2"><em>X<sub>d</em></sub> :<input class="rmoe-input" value="0.0"> km</p>
            <p class="container-title2"><em>Y<sub>d</sub></em> :<input class="rmoe-input" value="10.0"> km</p>
            <p class="container-title2"><em>&#946</em>: <input class="rmoe-input" value="0.0"> <sup>o</sup></p>
            <p class="container-title2"><u>Scenario Parameters</u></p>
            <p class="container-title2">Scenario Length: <input class="rmoe-input" value="15"> hrs</p>
            <p class="container-title2">&#916V Available: <input class="rmoe-input" value="2.5"> m/s</p>
            <p class="container-title2">Required CATS: <input class="rmoe-input" value="90"> <sup>o</sup></p>
            <p class="container-title2">Range: <input class="rmoe-input" value="10"> to <input class="rmoe-input"
                    value="15"> km</p>
        </div>
        <div class="setup-container">
            <p class="container-title" style="color: rgb(255,150,100)">Red Satellite</p>
            <p class="container-title2"><u>Initial State</u></p>
            <p class="container-title2"><em>Ae</em>: <input class="rmoe-input" value="0.0"> km</p>
            <p class="container-title2"><em>X<sub>d</em></sub> :<input class="rmoe-input" value="0.0"> km</p>
            <p class="container-title2"><em>Y<sub>d</sub></em> :<input class="rmoe-input" value="-10.0"> km</p>
            <p class="container-title2"><em>&#946</em>: <input class="rmoe-input" value="0.0"> <sup>o</sup></p>
        </div>
        <div class="setup-container">
            <div style="display: none;">
                <p class="container-title" style="color: rgb(150,150,150)">Grey Satellite #1</p>
                <p class="container-title2"><u>Initial State</u></p>
                <p class="container-title2"><em>Ae</em>: <input class="rmoe-input" value="0.0"> km</p>
                <p class="container-title2"><em>X<sub>d</em></sub> :<input class="rmoe-input" value="0.0"> km</p>
                <p class="container-title2"><em>Y<sub>d</sub></em> :<input class="rmoe-input" value="0.0"> km</p>
                <p class="container-title2"><em>&#946</em>: <input class="rmoe-input" value="0.0"> <sup>o</sup></p>
            </div>
            <div class="add-button"
                style="margin: 100% 40%; padding: 5%; text-align: center; border: 1px solid white; border-radius: 50%;">
                +</div>
        </div>
        <div class="setup-container">
            <div style="display: none;">
                <p class="container-title" style="color: rgb(150,150,150)">Grey Satellite #2</p>
                <p class="container-title2"><u>Initial State</u></p>
                <p class="container-title2"><em>Ae</em>: <input class="rmoe-input" value="0.0"> km</p>
                <p class="container-title2"><em>X<sub>d</em></sub> :<input class="rmoe-input" value="0.0"> km</p>
                <p class="container-title2"><em>Y<sub>d</sub></em> :<input class="rmoe-input" value="0.0"> km</p>
                <p class="container-title2"><em>&#946</em>: <input class="rmoe-input" value="0.0"> <sup>o</sup></p>
            </div>
            <div class="add-button"
                style="margin: 100% 40%; padding: 5%; text-align: center; border: 1px solid white; border-radius: 50%;">
                +</div>
        </div>
        <div class="sun-angle">Initial Sun <input class="rmoe-input" id="sun" value="90"><sup>o</sup></div>
        <div class="start-button">Start</div>
    </div>
    <div class="sideBar">
        <div class="controlTitle pointer"><span>Engagement Data</span></div>
        <div class="side-data" id="dataContainer">
            <p class="dropdown-item">Current Range: <span>0.00</span> km</p>
            <p class="dropdown-item">Close Approach: <span>0.00</span> km @ T +<span>0.0</span> hrs</p>
            <p class="dropdown-item">CATS Angle: <span>0.00</span> degrees</p>
            <p class="dropdown-item">Blue &#916V: <span>0.00</span> m/s</p>
            <p class="dropdown-item">Red &#916V: <span>0.00</span> m/s</p>
        </div>
        <div class="controlTitle pointer"><span style="color:rgb(100,150,255)">Blue Satellite</span></div>
        <div class="side-data" id="dataContainer" style="display: none;">
            <table class="table" id="burnTable" style="margin-top: 3%;">
                <thead>
                    <tr>
                        <th>Time [hrs]</th>
                        <th>Radial [m/s]</th>
                        <th>In-Track [m/s]</th>
                    </tr>
                </thead>

                <tbody class="pointer" id="burnTableBody">
                    <tr>
                        <th>+0</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <th>+3</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <th>+6</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <th>+9</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <th>+12</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="controlTitle pointer"><span style="color:rgb(255,100,50)">Red Satellite</span></div>
        <div class="side-data" id="dataContainer" style="display: none;">
            <table class="table" id="burnTable" style="margin-top: 3%;">
                <thead>
                    <tr>
                        <th>Time [hrs]</th>
                        <th>Radial [m/s]</th>
                        <th>In-Track [m/s]</th>
                    </tr>
                </thead>
                <tbody class="pointer" id="burnTableBody">
                    <tr>
                        <th>+0</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <th>+3</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <th>+6</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <th>+9</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                    <tr>
                        <th>+12</th>
                        <td>0.00</td>
                        <td>0.00</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div style="width:95%; height:auto; margin: auto; padding-top: 2.5%">
        <canvas id="ChartCnvs" width="51" height="23"></canvas>
    </div>
    <div class="slider-contain">
        <p>Time: T +<span>0.00</span> hrs</p>
        <input type="range" class="slider" min="0" max="15" value="0" step="0.01">
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
        var teamNum, $turn = $('#turn-button p span')[0];
        createGraph();
        $.get("./start", (data, status) => {
            teamNum = data;
        });
        $('#setup').on('click', () => {
            $('.instruction-screen').slideToggle(250);
        })
        $('#turn-button').on('click', () => {
            let turn = $('#turn-button p span')[0].textContent;
            turn++;
            setSelectedWaypoint(turn - 1, 'blue');
            $('#turn-button p span')[0].textContent = turn;
        })
        $('.start-button').on('click', () => {
            $('.setup-screen').fadeOut(500);
            let n = 2 * Math.PI / 86164;
            let $inputs = $('.setup-container').find('input');
            app.initSunVector = [
                [15*Math.cos($('#sun')[0].value*Math.PI/180)],
                [15*Math.sin($('#sun')[0].value*Math.PI/180)]
            ];

            let blueInit = [
                [-Number($inputs[0].value) / 2 * Math.cos(Number($inputs[3].value) * Math.PI / 180) +
                    Number($inputs[1].value)
                ],
                [Number($inputs[0].value) * Math.sin(Number($inputs[3].value) * Math.PI / 180) + Number(
                    $inputs[2].value)],
                [Number($inputs[0].value) * n / 2 * Math.sin(Number($inputs[3].value) * Math.PI / 180)],
                [Number($inputs[0].value) * n * Math.cos(Number($inputs[3].value) * Math.PI / 180) - 1.5 *
                    Number($inputs[1].value) * n
                ]
            ];
            let redInit = [
                [-Number($inputs[9].value) / 2 * Math.cos(Number($inputs[12].value) * Math.PI / 180) +
                    Number($inputs[10].value)
                ],
                [Number($inputs[9].value) * Math.sin(Number($inputs[12].value) * Math.PI / 180) + Number(
                    $inputs[11].value)],
                [Number($inputs[9].value) * n / 2 * Math.sin(Number($inputs[12].value) * Math.PI / 180)],
                [Number($inputs[9].value) * n * Math.cos(Number($inputs[12].value) * Math.PI / 180) - 1.5 *
                    Number($inputs[10].value) * n
                ]
            ];
            app.players.blue = new Satellite(blueInit, 'blue', {
                way: 0,
                traj: 1,
                cur: 9
            });
            app.players.red = new Satellite(redInit, 'red', {
                way: 3,
                traj: 4,
                cur: 10
            });
            let init;
            if ($('.setup-container').eq(2).find('div').eq(0).is(':visible')) {
                init = [
                    [-Number($inputs[13].value) / 2 * Math.cos(Number($inputs[16].value) * Math.PI / 180) +
                        Number($inputs[14].value)
                    ],
                    [Number($inputs[13].value) * Math.sin(Number($inputs[16].value) * Math.PI / 180) + Number(
                        $inputs[15].value)],
                    [Number($inputs[13].value) * n / 2 * Math.sin(Number($inputs[16].value) * Math.PI / 180)],
                    [Number($inputs[13].value) * n * Math.cos(Number($inputs[16].value) * Math.PI / 180) - 1.5 *
                        Number($inputs[14].value) * n
                    ]
                ];
                app.players.gray1 = new Satellite(init,'gray1',{traj: 14, cur: 13})
            }
            if ($('.setup-container').eq(3).find('div').eq(0).is(':visible')) {
                init = [
                    [-Number($inputs[17].value) / 2 * Math.cos(Number($inputs[20].value) * Math.PI / 180) +
                        Number($inputs[18].value)
                    ],
                    [Number($inputs[17].value) * Math.sin(Number($inputs[20].value) * Math.PI / 180) + Number(
                        $inputs[19].value)],
                    [Number($inputs[17].value) * n / 2 * Math.sin(Number($inputs[20].value) * Math.PI / 180)],
                    [Number($inputs[17].value) * n * Math.cos(Number($inputs[20].value) * Math.PI / 180) - 1.5 *
                        Number($inputs[18].value) * n
                    ]
                ];
                app.players.gray2 = new Satellite(init,'gray2',{traj: 16, cur: 15})
            }
            app.deltaVAvail = Number($inputs[5].value);
            app.reqCats = Number($inputs[6].value);
            setInterval(() => {
                out = JSON.stringify(Object.assign({}, app.players.blue.burns));
                $.post("./team" + teamNum, out, (data, status) => {
                    let turn = Number($turn.textContent) - 1;
                    let tempBurns = Object.values(JSON.parse(data));
                    change = false;
                    let sat = 'red';
                    for (let ii = 0; ii < turn; ii++) {
                        if ((app.players.red.burns[ii][0] === tempBurns[ii][0]) && (app.players
                                .red.burns[ii][1] === tempBurns[ii][1])) {
                            continue;
                        } else {
                            app.players.red.burns[ii] = tempBurns[ii];
                            change = true;
                            app.spans.manRows[sat][ii * 2].textContent = (tempBurns[ii][0])
                                .toFixed(2);
                            app.spans.manRows[sat][ii * 2 + 1].textContent = (tempBurns[ii][1])
                                .toFixed(2);
                        }
                    }
                    if (change) {
                        app.players.red.calculateTrajecory();
                        calcData(app.currentTime);
                    }
                });
            }, 2500);
            startGame();
        })
        $('.add-button').on('click', (a) => {
            $(a.target).hide();
            $(a.target).prev().fadeIn();
        })
        $('.controlTitle').on('click', (a) => {
            if ($(a.target).is('span')) {
                a.target = $(a.target).parent();
            }
            if (!$(a.target).next().is(":hidden")) {
                $(a.target).next().slideUp(250);
                return;
            }
            $('.side-data').slideUp(250);
            $(a.target).next().slideDown(250);
        })
        $('.slider-contain input').on('input', (a) => {
            $(a.target).prev().find('span')[0].textContent = a.target.value;
            app.currentTime = Number(a.target.value)
            calcData(app.currentTime);
        })
        $('tr').on('click', (a) => {
            let ii = 0;
            while (!$(a.target).is('tr')) {
                a.target = $(a.target).parent();
                console.log(a.target);
                ii++;
                if (ii > 5) {
                    break;
                }
            }
            ii = $('tr').index(a.target);
            if ((ii === 0) || (ii === 6)) {
                return;
            }
            let sat = (ii > 6) ? 'red' : 'blue';
            if (app.chosenWaypoint === undefined) {
                app.tactic = '';
            } else if ((app.chosenWaypoint[0] === (ii-1)) && (sat === 'blue')) {
                console.log(1)
                app.tactic = 'burn';
            } else if ((app.chosenWaypoint[0] === (ii-7)) && (sat === 'red')) {
                console.log(2)
                app.tactic = 'burn';
            } else {
                console.log(3)
                app.tactic = '';
            }
            setSelectedWaypoint((ii > 6) ? ii - 7 : ii - 1, sat);
            globalChartRef.config.data.datasets[app.dataLoc.burnDir].data = [{
                x: 0,
                y: 0
            }, {
                x: 0,
                y: 0
            }];

        })
        var burnRows, dataRows; {
            let $tableRows = $('td');
            app.spans.manRows = {
                blue: $tableRows.splice(0, 10),
                red: $tableRows
            }
            $tableRows = $('.side-data span');
            app.spans.scenData = {
                curRange: $tableRows.splice(0, 1),
                minRange: $tableRows.splice(0, 2),
                cats: $tableRows.splice(0, 1),
                totalDv: {
                    blue: $tableRows.splice(0, 1),
                    red: $tableRows.splice(0, 1)
                }
            }
        }
    </script>
</body>

</html>