<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .controls {
            position: absolute;
            float: left;
            width: 20%;
            /* height: 40%; */
            top: 6.25%;
            background-color: rgba(50,50,50,0.5);
            /* display: none; */
            color: white;
        }
        .controlTitle {
            position: absolute;
            width: 20%;
            height: 5%;
            float: left;
            color: white;
            text-align: center;
            font-weight: bold;
            z-index: 2;
            font-size: 2vw;
        }
        .controlTitle:hover {
            background-color: rgba(50,50,50,0.5);
        }
        input {
            width: 100%;
        }
        .slidercontainer {
            padding: 1.5% 10%;
            font-size: 1.5vw;
        }
    </style>
</head>
<body>
    <div class="controlTitle">Change Elements</div>
    <div class="controls">
        <div class="slidercontainer">
			<p><em>a</em>: <span>26650</span> km</p>
			<input type="range" class="slider" min="6600" max="50000" value="26650" step="1">
		</div>
        <div class="slidercontainer">
			<p><em>e</em>: <span>0.73</span></p>
            <input type="range" class="slider" min="0" max="0.9" value="0.73" step="0.01">
		</div>
        <div class="slidercontainer">
			<p><em>i</em>: <span>63.4</span> deg</p>
			<input type="range" class="slider" min="0" max="180" value="63.4" step="0.01">
		</div>
        <div class="slidercontainer">
			<p><em>&#937</em>: <span>0.0</span> deg</p>
			<input type="range" class="slider" min="0" max="360" value="0" step="0.1">
		</div>
        <div class="slidercontainer">
			<p><em>&#969</em>: <span>270.00</span> deg</p>
			<input type="range" class="slider" min="0" max="360" value="270" step="0.1">
		</div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.6.2/math.min.js"></script>
    <script src="SupportLibraries/astroFunctions.js"></script>
    <script type="module">
        import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r115/build/three.module.js';
        import {OrbitControls} from 'https://threejsfundamentals.org/threejs/resources/threejs/r115/examples/jsm/controls/OrbitControls.js';
        console.log(Coe2PosVel);
        
        var orbitParams = {
            a: 26650,
            e: 0.730,
            i: 63.4,
            raan: 0,
            arg: 270,
            mA: 0
        }

        var Earth, clouds, Sunlight, satPoint, orbit = undefined, r = 2, scene, camera, renderer, controls;
        setupScene();
        drawEarth();
        drawStars();
        drawLightSources();
        drawOrbit(orbitParams);

        var render = function() {
            renderer.render(scene,camera);
            controls.update();
            requestAnimationFrame(render);
            // line.attributes.position.
            // orbitParams.raan += 0.1;
            orbitParams.mA += 68.5*180/Math.PI*Math.sqrt(398600.4418/Math.pow(orbitParams.a,3));;
            console.log(orbitParams.mA)
            Earth.rotation.y += 0.005;
            clouds.rotation.y += 0.005;
            drawOrbit(orbitParams) 
        }

        render();

        function setupScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight);
            camera.position.set( 0, 0, 10 );
            renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(window.innerWidth,window.innerHeight);
            $('body').append(renderer.domElement);
            window.addEventListener('resize',() => {
                renderer.setSize(window.innerWidth,window.innerHeight);
                camera.aspect = window.innerWidth/window.innerHeight;

                camera.updateProjectionMatrix();
            })
            
            controls = new OrbitControls(camera,renderer.domElement);
        }

        function drawOrbit(orbitParams) {
            let tA = Eccentric2True(orbitParams.e,solveKeplersEquation(orbitParams.mA*Math.PI/180,orbitParams.e))
            let period = 2*Math.PI*Math.sqrt(Math.pow(orbitParams.a,3)/398600.4418);
            let coe = [orbitParams.a, orbitParams.e, orbitParams.i*Math.PI/180, orbitParams.raan*Math.PI/180, orbitParams.arg*Math.PI/180, tA]
            let r;
            var points = [];
            
            for (var ii = 0; ii <= 200; ii++) {
                coe = twoBodyProp(coe,-0.6*period/199);
                r = Coe2PosVel(coe);
                
                points.push( new THREE.Vector3( -r[0][0][0]/6371, r[0][2][0]/6371, r[0][1][0]/6371 ));
            }
            if (orbit === undefined){ 
                var material = new THREE.LineBasicMaterial({
                    color: 0x1e90ff,
                    linewidth: 30
                });
                var geometry = new THREE.BufferGeometry().setFromPoints( points );
                orbit = new THREE.Line( geometry, material );
                var geometry = new THREE.SphereGeometry( 0.05, 6, 6 );
                var material = new THREE.MeshBasicMaterial({
                    color: 0x1e90ff});
                satPoint = new THREE.Mesh( geometry, material );
                coe = [orbitParams.a, orbitParams.e, orbitParams.i*Math.PI/180, orbitParams.raan*Math.PI/180, orbitParams.arg*Math.PI/180, tA]
                r = Coe2PosVel(coe);
                satPoint.position.x = -r[0][0][0]/6371;
                satPoint.position.y = r[0][2][0]/6371;
                satPoint.position.z = r[0][1][0]/6371;

                scene.add(satPoint);
                scene.add(orbit);
            }
            else {
                // Edit orbitVar
                orbit.geometry.setFromPoints(points);
                coe = [orbitParams.a, orbitParams.e, orbitParams.i*Math.PI/180, orbitParams.raan*Math.PI/180, orbitParams.arg*Math.PI/180, tA]
                r = Coe2PosVel(coe);
                satPoint.position.x = -r[0][0][0]/6371;
                satPoint.position.y = r[0][2][0]/6371;
                satPoint.position.z = r[0][1][0]/6371;
            }
        }

        function drawEarth(){
            var texture = new THREE.TextureLoader().load( 'https://pkevz90.github.io/pkevz.github.io/2_no_clouds_4k.jpg' );
            var cloudsTexture = new THREE.TextureLoader().load('https://pkevz90.github.io/pkevz.github.io/fair_clouds_4k.png');
            var geometry = new THREE.SphereGeometry( 1, 64, 64 );
            var material = new THREE.MeshLambertMaterial( {
                map: texture
            } );
            Earth = new THREE.Mesh( geometry, material );
            scene.add(Earth);
            clouds = new THREE.Mesh(
                new THREE.SphereGeometry(1.003, 64, 64),			
                new THREE.MeshPhongMaterial({
                    map:  cloudsTexture,
                    transparent: true
                })
		    );	
            scene.add(clouds);
            Earth.position.z = 0;
        }
        
        function drawStars(){
            var starTexture = new THREE.TextureLoader().load( 'https://pkevz90.github.io/pkevz.github.io/galaxy_starfield.png' );

            var stars = new THREE.Mesh(
                new THREE.SphereGeometry(90, 64, 64), 
                new THREE.MeshBasicMaterial({
                    map: starTexture,     
                    side: THREE.BackSide
                })
            );
            scene.add(stars);
        }

        function drawLightSources() {
            var Sunlight = new THREE.PointLight(0xFFFFFF, 1, 500);
            Sunlight.position.set(10,2,12);
            scene.add(Sunlight);
            var light1 = new THREE.AmbientLight( 0xFFFFFF,0.2 ); // soft white light
            scene.add( light1 );
        }
    
        $('input').on('input',()=>{
            orbitParams = {
                a:      Number($('input')[0].value),
                e:      Number($('input')[1].value),
                i:      Number($('input')[2].value),
                raan:   Number($('input')[3].value),
                arg:    Number($('input')[4].value),
                mA:     orbitParams.mA
            }
            for (var ii = 0; ii < 5; ii++) {
                $('.controls span')[ii].textContent = $('input')[ii].value;
            }
            drawOrbit(orbitParams);
        })
    </script>
</body>
</html>